# OAuth 2.0 Аутентификация с Яндекс

## Описание подхода

Эта реализация использует **OAuth 2.0** с Яндекс как Identity Provider. Пользователи аутентифицируются через Яндекс, а ваше приложение получает информацию о пользователе и создает собственную сессию.

### Особенности:
- **Внешний провайдер**: Яндекс обрабатывает аутентификацию
- **Безопасность**: не храните пароли пользователей
- **Удобство**: пользователи используют существующие аккаунты Яндекса
- **Доверие**: Яндекс гарантирует подлинность пользователя

## Технологии

- **FastAPI** - современный веб-фреймворк
- **httpx** - асинхронный HTTP клиент для работы с Яндекс API
- **PyJWT** - работа с JSON Web Tokens
- **SQLite** - база данных пользователей

## Настройка Яндекс OAuth 2.0

### 1. Регистрация приложения в Яндекс OAuth

1. Перейдите на [страницу регистрации приложений Яндекса](https://oauth.yandex.ru/client/new)
2. Укажите название приложения и выберите платформу "Веб-сервисы"
3. В поле "Callback URI" укажите URL: `http://localhost:8000/auth/yandex/callback`
4. Выберите необходимые права доступа:
   - `login:email` - доступ к email адресу
   - `login:info` - доступ к основной информации профиля
5. Сохраните полученные `Client ID` и `Client Secret`

### 2. Обновление конфигурации

Замените в `main.py`:
```python
YANDEX_CLIENT_ID = "ваш-client-id"
YANDEX_CLIENT_SECRET = "ваш-client-secret"
```

## Установка и запуск

1. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate     # Windows
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Настройте Яндекс OAuth 2.0 (см. выше)

4. Запустите приложение:
```bash
python main.py
```

5. Откройте браузер: http://localhost:8000

## Использование

### Веб-интерфейс
1. Откройте http://localhost:8000
2. Нажмите "Войти через Яндекс"
3. Авторизуйтесь в Яндексе
4. Вы будете перенаправлены обратно в приложение
5. Используйте кнопки для проверки профиля и выхода

### API через curl

#### Получение профиля (требует access токен):
```bash
curl http://localhost:8000/profile \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

#### Выход:
```bash
curl -X POST http://localhost:8000/logout
```

## Безопасность

- **JWT подпись**: токены подписываются секретным ключом
- **Время жизни токенов**: access токен действует 24 часа
- **HTTPS**: в продакшене обязательно используйте HTTPS
- **Валидация**: проверка токенов от Яндекса
- **Отзыв токенов**: возможность отозвать токены через Яндекс

## Архитектура

```
Клиент (Браузер)
    ↓ перенаправление на Яндекс
Яндекс OAuth 2.0
    ↓ callback с кодом авторизации
FastAPI приложение
    ↓ обмен кода на токен + получение данных пользователя
Яндекс API
    ↓ сохранение/получение пользователя
SQLite (пользователи)
```

## OAuth 2.0 Flow

1. **Authorization Request**: клиент перенаправляется на Яндекс
2. **User Authorization**: пользователь авторизуется в Яндексе
3. **Authorization Grant**: Яндекс возвращает код авторизации
4. **Access Token Request**: приложение обменивает код на access токен
5. **Protected Resource**: приложение получает данные пользователя
6. **Local Session**: создается локальная сессия с JWT токеном

## Преимущества OAuth 2.0 с Яндекс

1. **Безопасность**: не храните пароли пользователей
2. **Удобство**: пользователи используют существующие аккаунты Яндекса
3. **Доверие**: Яндекс гарантирует подлинность
4. **Стандартизация**: открытый стандарт OAuth 2.0
5. **Русскоязычная аудитория**: популярность Яндекса в России

## Недостатки

1. **Зависимость**: зависимость от внешнего сервиса
2. **Сложность**: более сложная настройка
3. **Приватность**: провайдер знает о ваших пользователях
4. **Офлайн**: не работает без интернета

## Расширение функциональности

### Добавление других провайдеров

Можно легко добавить поддержку других OAuth 2.0 провайдеров:

```python
# VK OAuth 2.0
VK_CLIENT_ID = "your-vk-app-id"
VK_CLIENT_SECRET = "your-vk-app-secret"

# Mail.ru OAuth 2.0
MAILRU_CLIENT_ID = "your-mailru-app-id"
MAILRU_CLIENT_SECRET = "your-mailru-app-secret"
```

### Объединение аккаунтов

Можно связать несколько OAuth аккаунтов с одним пользователем:

```sql
CREATE TABLE user_oauth_accounts (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    provider TEXT,
    provider_id TEXT,
    FOREIGN KEY (user_id) REFERENCES users (id)
);
```

## Переменные окружения

Для продакшена используйте переменные окружения:

```bash
export YANDEX_CLIENT_ID="your-client-id"
export YANDEX_CLIENT_SECRET="your-client-secret"
export SECRET_KEY="your-secret-key"
```

И обновите код:
```python
YANDEX_CLIENT_ID = os.getenv("YANDEX_CLIENT_ID")
YANDEX_CLIENT_SECRET = os.getenv("YANDEX_CLIENT_SECRET")
SECRET_KEY = os.getenv("SECRET_KEY")
```
